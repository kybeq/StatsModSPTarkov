{% extends "base.html" %} {% block title %}Profil Gracza: {{ nickname }} -
StatsMods Tarkov{% endblock %} {% block content %} {# Sprawdzenie czy mamy dane
gracza #} {% if player_info %} {# Dynamiczna klasa główna sekcji #}
<section
  class="{% if player_info.latest_side == 'bear' %}bear{% elif player_info.latest_side == 'usec' %}usec{% else %}default-profile{% endif %}"
>
  {# Górne karty z informacjami o graczu - dynamiczne klasy #}
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card h-100">
        {# Użyj klas danger dla BEAR, primary dla USEC/innych #}
        <div
          class="card-body shadow-lg {% if player_info.latest_side == 'bear' %}text-danger-emphasis bg-danger-subtle border-danger-subtle{% else %}text-primary-emphasis bg-primary-subtle border-primary-subtle{% endif %}"
        >
          <h5>Name</h5>
          {# Zachowuję 'Name' jak w Twoim kodzie #}
          <h1>{{ nickname }}</h1>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100">
        <div
          class="card-body shadow {% if player_info.latest_side == 'bear' %}text-danger-emphasis bg-danger-subtle border-danger-subtle{% else %}text-primary-emphasis bg-primary-subtle border-primary-subtle{% endif %}"
        >
          <h5>Frakcja</h5>
          <h1>{{ get_item_name(player_info.latest_side) }}</h1>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100">
        <div
          class="card-body shadow {% if player_info.latest_side == 'bear' %}text-danger-emphasis bg-danger-subtle border-danger-subtle{% else %}text-primary-emphasis bg-primary-subtle border-primary-subtle{% endif %}"
        >
          <h5>Poziom</h5>
          <h1>{{ player_info.latest_level or 'N/A' }}</h1>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100">
        <div
          class="card-body shadow {% if player_info.latest_side == 'bear' %}text-danger-emphasis bg-danger-subtle border-danger-subtle{% else %}text-primary-emphasis bg-primary-subtle border-primary-subtle{% endif %}"
        >
          <h5>Total EXP</h5>
          <h1>{{ player_info.latest_total_experience_formatted }}</h1>
          {# Sformatowane w app.py #}
        </div>
      </div>
    </div>
  </div>

  {# Drugi rząd kart ze statystykami - zachowuję Twoje klasy #}
  <div class="row g-3 my-1 mb-4">
    {# Dodałem mb-4 dla spójności #}
    <div class="col">
      <div class="card h-100">
        {# Dodałem h-100 dla równej wysokości #}
        <div
          class="card-body shadow text-info-emphasis bg-info-subtle border border-info-subtle"
        >
          <h5>Sesje PMC</h5>
          <h2>{{ player_stats.sessions }}</h2>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100">
        <div
          class="card-body shadow text-success-emphasis bg-success-subtle border border-success-subtle"
        >
          <h5>Survival</h5>
          {# Przeżyte sesje #}
          <h2>{{ player_stats.survived_sessions }}</h2>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100">
        <div
          class="card-body shadow text-danger-emphasis bg-danger-subtle border border-danger-subtle"
        >
          <h5>No Survival</h5>
          {# Śmierci #}
          <h2>{{ player_stats.deaths }}</h2>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100">
        <div
          class="card-body shadow text-info-emphasis bg-info-subtle border border-info-subtle"
        >
          <h5>Total Kill</h5>
          <h2>{{ player_stats.kills }}</h2>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100">
        <div
          class="card-body shadow text-info-emphasis bg-info-subtle border border-info-subtle"
        >
          <h5>Survival Rate</h5>
          <h2>{{ player_stats.survival_rate }}</h2>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100">
        <div
          class="card-body shadow text-info-emphasis bg-info-subtle border border-info-subtle"
        >
          {# Zmieniam drugie SR na K/D #}
          <h5>K/D Ratio</h5>
          <h2>{{ player_stats.kd_ratio }}</h2>
        </div>
      </div>
    </div>
  </div>

  <hr class="col col-md-12 my-5" />

  {# Sekcja z ostatnim rajdem i historią rajdów - taka sama dla obu #}
  <div class="row g-5">
    <div class="col-md-4 col-sm-12 border-end">
      <h1 class="mb-5">Ostatni rajd</h1>
      {# Zachowuję H1 jak w Twoim kodzie #} {% if latest_raid %}
      <div class="card mb-3 shadow-lg">
        {% if latest_raid.location %}
        <img
          src="{{ url_for('static', filename=get_map_image_url(latest_raid.location)) }}"
          class="img-fluid"
          alt="{{ latest_raid.location }}"
        />
        {# Zmieniono na img-fluid #} {% else %}
        <img
          src="{{ url_for('static', filename=get_map_image_url('unknown')) }}"
          class="img-fluid"
          alt="Nieznana mapa"
        />
        {% endif %}
        <div class="card-body">
          <h3 class="card-title">{{ latest_raid.location or 'Nieznana' }}</h3>
          {# Format daty jak w Twoim kodzie #}
          <p class="card-text">
            <small class="text-body-secondary"
              >Zakończono: {{ latest_raid.timestamp_formatted }}</small
            >
          </p>
        </div>
        <ul class="list-group list-group-flush">
          <li
            class="list-group-item p-3 {% if latest_raid.raid_result == 'Survived' %}text-success-emphasis bg-success-subtle border-success-subtle{% elif latest_raid.raid_result == 'Killed' %}text-danger-emphasis bg-danger-subtle border-danger-subtle{% else %}text-warning-emphasis bg-warning-subtle border-warning-subtle{% endif %}"
          >
            <small>Status</small>
            <h3>{{ latest_raid.raid_result or 'N/A' }}</h3>
          </li>
          <li class="list-group-item p-3">
            <small>Czas</small>
            <h3>{{ latest_raid.play_time_formatted }}</h3>
          </li>
          {# Struktura listy poziomej jak w Twoim kodzie #}
          <ul class="list-group list-group-horizontal">
            <li class="list-group-item col border border-0">
              <small>Total Kill</small>
              <h4>{{ latest_raid.kills_count }}</h4>
            </li>
            {# Usunięto Bosses - brak danych #}
            <li class="list-group-item col border border-0">
              <small>Exit</small>
              {# Wyświetlaj tylko jeśli Survived #}
              <h4>
                {{ latest_raid.exit_name if latest_raid.raid_result ==
                'Survived' else '---' }}
              </h4>
            </li>
          </ul>
        </ul>
      </div>
      {% else %}
      <p>Brak danych o ostatnim rajdzie tego gracza.</p>
      {% endif %}
    </div>
    <div class="col-md-8 col-sm-12">
      <h1 class="mb-5">Ostatnie rajdy</h1>
      {# Zachowuję H1 #} {% if player_raids %}
      <div class="table-responsive">
        {# Klasy tabeli jak w Twoim kodzie #}
        <table class="table table-striped text-center">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Data</th>
              <th scope="col">Mapa</th>
              <th scope="col">Wynik</th>
              <th scope="col">Czas</th>
              <th scope="col">Kill</th>
              <th scope="col">EXP</th>
              <th scope="col">Szczegóły</th>
            </tr>
          </thead>
          <tbody>
            {% for raid in player_raids %}
            <tr>
              <th scope="row">{{ loop.index }}</th>
              <td>{{ raid.timestamp_formatted }}</td>
              <td>{{ raid.location or 'N/A' }}</td>
              <td>{{ raid.raid_result or 'N/A' }}</td>
              <td>{{ raid.play_time_formatted }}</td>
              <td>{{ raid.kills_count }}</td>
              {# Formatowanie EXP #}
              <td>{{ format_exp(raid.total_session_exp_calculated) }}</td>
              <td>
                {# Przycisk modala, ID modala zmienione na raidDetailsModal #}
                <button
                  type="button"
                  class="btn btn-secondary btn-sm open-raid-modal"
                  data-bs-toggle="modal"
                  data-bs-target="#raidDetailsModal"
                  data-filename="{{ raid.filename }}"
                >
                  zobacz
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p>Brak historii rajdów dla tego gracza.</p>
      {% endif %}
    </div>
  </div>

  {# Sekcje tylko dla BEAR #} {% if player_info.latest_side == 'bear' %}
  <hr class="col col-md-12 my-5" />
  {# Sekcja Umiejętności #}
  <section>
    <div class="row">
      <div class="col">
        <h1 class="mb-5">Umiejętności</h1>
        {# Zachowuję H1 #}
      </div>
    </div>
    {% if skills %}
    <div class="row g-3">
      {# Zmieniono na g-3 jak w Twoim kodzie #}
      <div class="col">
        {# Usunięto md-6 dla pełnej szerokości na mniejszych ekranach #}
        <h4 class="mb-1 card p-3">Common</h4>
        <ol class="list-group">
          {% for skill in skills if skill.SkillType == 'Common' %} {# Zachowuję
          Twoją strukturę li #}
          <li
            class="list-group-item d-flex justify-content-between align-items-start p-3 gap-5 shadow"
          >
            <div class="col">
              {# Usunięto me-3 #}
              <div class="fw-bold fs-4 mb-2">{{ skill.SkillName }}</div>
              {# Zachowuję fs-4 #} {# Twoja struktura progress bar #}
              <div
                class="progress"
                role="progressbar"
                aria-label="Skill progress"
                aria-valuenow="{{ skill.Progress }}"
                aria-valuemin="0"
                aria-valuemax="100"
              >
                <div
                  class="progress-bar text-bg-info progress-bar-striped progress-bar-animated"
                  style="width: {{ skill.Progress }}%"
                >
                  {{ skill.ProgressFormatted }}
                </div>
              </div>
            </div>
            {# Twój badge #}
            <span class="badge text-bg-info border-0 p-3"
              >+{{ skill.PointsEarnedFormatted }}</span
            >
          </li>
          {% else %}
          <li class="list-group-item">Brak zmian w umiejętnościach Common.</li>
          {% endfor %}
        </ol>
      </div>
      <div class="col">
        <h4 class="mb-1 card p-3">Mastering</h4>
        <ol class="list-group">
          {% for skill in skills if skill.SkillType == 'Mastering' %}
          <li
            class="list-group-item d-flex justify-content-between align-items-start p-3 gap-5 shadow"
          >
            <div class="col">
              <div class="fw-bold fs-4 mb-2">{{ skill.SkillName }}</div>
              <div
                class="progress"
                role="progressbar"
                aria-label="Skill progress"
                aria-valuenow="{{ skill.Progress }}"
                aria-valuemin="0"
                aria-valuemax="100"
              >
                {# Używam warning dla Mastering dla odróżnienia #}
                <div
                  class="progress-bar text-bg-warning progress-bar-striped progress-bar-animated"
                  style="width: {{ skill.Progress }}%"
                >
                  {{ skill.ProgressFormatted }}
                </div>
              </div>
            </div>
            <span class="badge text-bg-warning border-0 p-3">
              {# text-bg-warning #} {% if skill.PointsEarnedFormatted != 'N/A'
              and skill.PointsEarnedFormatted != '0.00' %} +{{
              skill.PointsEarnedFormatted }} {% else %} --- {# Placeholder jeśli
              brak pkt #} {% endif %}
            </span>
          </li>
          {% else %}
          <li class="list-group-item">
            Brak zmian w umiejętnościach Mastering.
          </li>
          {% endfor %}
        </ol>
      </div>
    </div>
    {% else %}
    <p>Brak danych o zmianach umiejętności w ostatnim rajdzie.</p>
    {% endif %}
  </section>

  <hr class="col col-md-12 my-5" />

  {# Sekcja Achievements #}
  <section>
    <div class="row">
      <div class="col">
        <h1 class="mb-5">Achievements</h1>
        {# Zachowuję H1 #}
      </div>
    </div>
    {# Zachowuję Twoją strukturę dla achievements #}
    <div class="row g-3">
      {# Dodałem g-3 #} {% if achievements %} {% for achievement in achievements
      %}
      <div class="col">
        {# Usunięto col-auto, pozwoli Bootstrapowi rozłożyć karty #}
        <div class="card text-center shadow" style="width: 10rem">
          {# Zakładam, że masz ID w achievement, dostosuj jeśli trzeba #}
          <img
            src="{{ url_for('static', filename='achievements/' + achievement.id + '.png') }}"
            class="card-img p-2"
            alt="{{ achievement.name }}"
          />
          {# Zmieniono card-img na card-img-top? Raczej nie, zostawiam card-img
          #}
          <div class="card-body py-2">
            {# Zmniejszono padding pionowy #} {# Zmieniono h5 na h6 dla
            mniejszego fontu #}
            <h6 class="card-title small">{{ achievement.name }}</h6>
          </div>
        </div>
      </div>
      {% endfor %} {% else %}
      <div class="col">
        <p>Brak osiągnięć do wyświetlenia.</p>
      </div>
      {% endif %}
    </div>
  </section>
  {% endif %} {# Koniec sekcji tylko dla BEAR #}
</section>
{# Koniec głównej sekcji profilu #} {# Modal - ID zmienione na raidDetailsModal,
reszta struktury jak w poprzedniej wersji #}
<div
  class="modal fade"
  id="raidDetailsModal"
  tabindex="-1"
  aria-labelledby="raidDetailsModalLabel"
  aria-hidden="true"
>
  <div
    class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl"
  >
    <div class="modal-content rounded-0 p-3">
      <div class="modal-header border-0">
        {# Tytuł modala będzie ustawiany przez JS #}
        <h1 class="modal-title fs-4" id="raidDetailsModalLabel">
          Szczegóły rajdu
        </h1>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body" id="raidModalBody">
        {# --- Loader --- #}
        <div class="d-flex justify-content-center my-5" id="modalLoader">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Ładowanie...</span>
          </div>
        </div>
        {# --- Error Message --- #}
        <div class="alert alert-danger d-none" role="alert" id="modalError">
          Nie udało się załadować danych rajdu.
        </div>
        {# --- Content (initially hidden) --- #}
        <div id="modalContent" class="d-none">
          {# Sekcja Ofiar - struktura jak w Twoim kodzie #}
          <h4 class="mb-3">
            Ofiary gracza (<span id="modal-kills-count">0</span>)
          </h4>
          <div class="table-responsive mb-4">
            {# Dodano mb-4 #}
            <table class="table table-striped text-center">
              {# Twoje klasy #}
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">Name</th>
                  <th scope="col">LVL</th>
                  <th scope="col">Frakcja</th>
                  <th scope="col">GUN</th>
                  {# Rola? #}
                  <th scope="col">Distance</th>
                  <th scope="col">Where</th>
                  {# BodyPart #}
                </tr>
              </thead>
              <tbody id="modal-victims-table">
                {# Wiersze będą dodane przez JS, dopasowane do tych nagłówków #}
              </tbody>
            </table>
            <p id="modal-no-victims" class="text-center text-muted d-none">
              Brak ofiar w tym rajdzie.
            </p>
          </div>

          {# Podstawowe info rajdu - struktura jak w Twoim kodzie #}
          <div class="row g-3 mb-4">
            {# Dodano mb-4 #}
            <div class="col">
              <div class="card">
                {# Klasa karty wyniku będzie ustawiana dynamicznie przez JS #}
                <div
                  class="card-body shadow-lg shadow"
                  id="modal-raid-result-card"
                >
                  <h5>Wynik</h5>
                  {# Zmieniono Wyjście na Wynik #}
                  <hr />
                  <h2 id="modal-raid-result">N/A</h2>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h5>Wyjście</h5>
                  {# Dodano kartę Wyjście #}
                  <hr />
                  <h2 id="modal-exit-name">N/A</h2>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h5>Klasa</h5>
                  <hr />
                  <h2 id="modal-survivor-class">N/A</h2>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h5>Czas</h5>
                  <hr />
                  <h2 id="modal-play-time">N/A</h2>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h5>Graczy</h5>
                  <hr />
                  <h2 id="modal-player-count">N/A</h2>
                </div>
              </div>
            </div>
          </div>

          {# Info o zabójcy (jeśli dotyczy) - Struktura Kafelków #}
          <div id="modal-killer-info-section" class="mb-4 d-none">
            <h4 class="mb-3 text-danger">Informacje o zabójcy</h4>
            <div class="row g-3">
              {# Używamy row i col jak w innych sekcjach #}

              <div class="col">
                <div class="card h-100 bg-danger-subtle border-danger">
                  {# Dodano h-100 dla równej wysokości #}
                  <div class="card-body shadow">
                    {# Twoja klasa shadow #}
                    <h5>Nick</h5>
                    <hr />
                    <h2 id="modal-killer-name">N/A</h2>
                    {# Używamy H2 jak w Twoim przykładzie #}
                  </div>
                </div>
              </div>

              <div class="col">
                <div class="card h-100 bg-danger-subtle border-danger">
                  <div class="card-body shadow">
                    <h5>Rola</h5>
                    <hr />
                    <h2 id="modal-killer-role">N/A</h2>
                  </div>
                </div>
              </div>

              <div class="col">
                <div class="card h-100 bg-danger-subtle border-danger">
                  <div class="card-body shadow">
                    <h5>Frakcja</h5>
                    <hr />
                    <h2 id="modal-killer-side">N/A</h2>
                  </div>
                </div>
              </div>

              <div class="col">
                <div class="card h-100 bg-danger-subtle border-danger">
                  <div class="card-body shadow">
                    <h5>Broń</h5>
                    <hr />
                    <h2 id="modal-killer-weapon">N/A</h2>
                  </div>
                </div>
              </div>

              <div class="col">
                <div class="card h-100 bg-danger-subtle border-danger">
                  <div class="card-body shadow">
                    <h5>Trafienie</h5>
                    <hr />
                    <h2 id="modal-killer-bodypart">N/A</h2>
                  </div>
                </div>
              </div>

              <div class="col">
                <div class="card h-100 bg-danger-subtle border-danger">
                  <div class="card-body shadow">
                    <h5>Obrażenia</h5>
                    <hr />
                    <h2 id="modal-killer-damage">N/A</h2>
                  </div>
                </div>
              </div>

              <div class="col">
                <div class="card h-100 bg-danger-subtle border-danger">
                  <div class="card-body shadow">
                    <h5>Typ Obrażeń</h5>
                    <hr />
                    <h2 id="modal-killer-damagetype">N/A</h2>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {# Statystyki Sesji - struktura jak w Twoim kodzie #}
          <div class="row g-3 mt-1">
            {# Twoje klasy #}
            <h5 class="py-3">Statystyki Sesji</h5>
            <div class="col">
              <div class="card">
                <div class="card-body shadow-lg">
                  <h6>EXP</h6>
                  <hr />
                  <h3 id="modal-exp-total">0</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>EXP (JSON)</h6>
                  <hr />
                  <h3 id="modal-exp-json">0</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>Mnożnik</h6>
                  <hr />
                  <h3 id="modal-exp-mult">1x</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>Bonus</h6>
                  <hr />
                  <h3 id="modal-exp-bonus">1x</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>Zabójstwa</h6>
                  <hr />
                  <h3 id="modal-exp-kill">0</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>Przeszukiwanie</h6>
                  <hr />
                  <h3 id="modal-exp-loot">0</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>Wyjścia</h6>
                  <hr />
                  <h3 id="modal-exp-exit">0</h3>
                </div>
              </div>
            </div>
          </div>

          {# Walka i Ruch - struktura jak w Twoim kodzie #}
          <div class="row g-3 mt-1">
            {# Twoje klasy #}
            <h5 class="py-3">Walka i Ruch</h5>
            <div class="col">
              <div class="card">
                <div class="card-body shadow-lg">
                  <h6>Zadane</h6>
                  <hr />
                  <h3 id="modal-dmg-dealt">0</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>Otrzymane</h6>
                  <hr />
                  <h3 id="modal-dmg-received">0</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>Dystans</h6>
                  <hr />
                  <h3 id="modal-distance">0 m</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>Utrata Krwi</h6>
                  <hr />
                  <h3 id="modal-bloodloss">0</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>Śmierci w Sesji</h6>
                  <hr />
                  <h3 id="modal-deaths">0</h3>
                </div>
              </div>
            </div>
          </div>

          {# Otrzymane Obrażenia - Szczegóły - struktura jak w Twoim kodzie #}
          <div class="row g-3 mt-1">
            {# Twoje klasy #}
            <h5 class="py-3">Otrzymane Obrażenia</h5>
            {# Tutaj dynamicznie wstawimy karty z JS #}
            <div class="row g-3" id="modal-dmg-received-details">
              {# Przykład karty, JS wygeneruje resztę #}
              <p
                id="modal-no-dmg-received"
                class="text-center text-muted d-none"
              >
                Brak otrzymanych obrażeń.
              </p>
              {#
              <div class="col">
                <div class="card">
                  <div class="card-body shadow">
                    <h6>GŁOWA</h6>
                    <hr />
                    <h3>351</h3>
                  </div>
                </div>
              </div>
              #}
            </div>
          </div>

          {# Końcowe zdrowie - struktura jak w Twoim kodzie #}
          <div class="row mt-5">
            <div class="col-6">
              {# Używam col-6 jak w Twoim kodzie #}
              <h4 class="mb-1 card p-3">Końcowe Zdrowie i Witalność</h4>
              <ol class="list-group" id="modal-vitals-list">
                {# Paski progress będą dodane przez JS, zachowując Twoją
                strukturę li #}
              </ol>
            </div>
            <div class="col-6">
              <h4 class="mb-1 card p-3">Zdrowie Części Ciała</h4>
              <ol class="list-group" id="modal-bodyparts-list">
                {# Paski progress będą dodane przez JS, zachowując Twoją
                strukturę li #}
              </ol>
            </div>
          </div>

          {# Przedmioty - uproszczona lista (nowa sekcja) #}
          <hr class="my-5" />
          <div class="row mt-4">
            <div class="col-md-6 mb-4">
              <h4 class="mb-3">Znalezione w Rajdzie</h4>
              <ul
                class="list-group list-group-flush"
                id="modal-found-items"
              ></ul>
              <p id="modal-no-found-items" class="text-muted d-none">Brak</p>
            </div>
            <div class="col-md-6 mb-4">
              <h4 class="mb-3">Przeniesione (loot)</h4>
              <ul
                class="list-group list-group-flush"
                id="modal-transfer-items"
              ></ul>
              <p id="modal-no-transfer-items" class="text-muted d-none">Brak</p>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-4">
              <h4 class="mb-3">Upuszczone</h4>
              <ul
                class="list-group list-group-flush"
                id="modal-dropped-items"
              ></ul>
              <p id="modal-no-dropped-items" class="text-muted d-none">Brak</p>
            </div>
            <div class="col-md-6 mb-4">
              <h4 class="mb-3">Stracone Ubezpieczone</h4>
              <ul
                class="list-group list-group-flush"
                id="modal-lost-items"
              ></ul>
              <p id="modal-no-lost-items" class="text-muted d-none">Brak</p>
            </div>
          </div>
        </div>
        {# End modalContent #}
      </div>
      {# End modal-body #}
    </div>
  </div>
</div>

{% else %}
<div class="alert alert-danger" role="alert">
  Nie znaleziono informacji o graczu: {{ nickname }}
</div>
{% endif %} {# End if player_info #} {% endblock %} {% block scripts %} {{
super() }} {# Zachowaj skrypty z base.html jeśli są #} {# Ten sam skrypt co w
poprzedniej wersji, obsługuje modal #}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const raidDetailsModal = document.getElementById("raidDetailsModal");
    // Sprawdź, czy modal istnieje na stronie, zanim dodasz event listener
    if (!raidDetailsModal) return;

    const modalBody = document.getElementById("raidModalBody");
    const modalLoader = document.getElementById("modalLoader");
    const modalError = document.getElementById("modalError");
    const modalContent = document.getElementById("modalContent");
    const modalTitle = document.getElementById("raidDetailsModalLabel");

    // Elementy do wypełnienia w modalu (kompletna lista)
    const elements = {
      // Victims
      killsCount: document.getElementById("modal-kills-count"),
      victimsTable: document.getElementById("modal-victims-table"),
      noVictims: document.getElementById("modal-no-victims"),
      // Raid Info Cards (Your Structure)
      raidResult: document.getElementById("modal-raid-result"),
      raidResultCard: document.getElementById("modal-raid-result-card"), // Karta dla dynamicznych klas
      exitName: document.getElementById("modal-exit-name"),
      survivorClass: document.getElementById("modal-survivor-class"),
      playTime: document.getElementById("modal-play-time"), // Karta Czas
      playerCount: document.getElementById("modal-player-count"),
      // Killer Info (Definition List Structure)
      killerInfoSection: document.getElementById("modal-killer-info-section"),
      killerName: document.getElementById("modal-killer-name"),
      killerRole: document.getElementById("modal-killer-role"),
      killerSide: document.getElementById("modal-killer-side"),
      killerWeapon: document.getElementById("modal-killer-weapon"),
      killerBodypart: document.getElementById("modal-killer-bodypart"),
      killerDamage: document.getElementById("modal-killer-damage"),
      killerDamageType: document.getElementById("modal-killer-damagetype"),
      // Session Stats Cards (Your Structure)
      expTotal: document.getElementById("modal-exp-total"), // h3 w karcie EXP
      expJson: document.getElementById("modal-exp-json"), // h3 w karcie EXP (JSON)
      expMult: document.getElementById("modal-exp-mult"), // h3 w karcie Mnożnik
      expBonus: document.getElementById("modal-exp-bonus"), // h3 w karcie Bonus
      expKill: document.getElementById("modal-exp-kill"), // h3 w karcie Zabójstwa
      expLoot: document.getElementById("modal-exp-loot"), // h3 w karcie Przeszukiwanie
      expExit: document.getElementById("modal-exp-exit"), // h3 w karcie Wyjścia
      // Combat & Movement Cards (Your Structure)
      dmgDealt: document.getElementById("modal-dmg-dealt"), // h3 w karcie Zadane
      dmgReceived: document.getElementById("modal-dmg-received"), // h3 w karcie Otrzymane
      distance: document.getElementById("modal-distance"), // h3 w karcie Dystans
      bloodloss: document.getElementById("modal-bloodloss"), // h3 w karcie Utrata Krwi
      deaths: document.getElementById("modal-deaths"), // h3 w karcie Śmierci w Sesji
      // Received Damage Details (Card Container)
      dmgReceivedDetails: document.getElementById("modal-dmg-received-details"), // div dla kart
      noDmgReceived: document.getElementById("modal-no-dmg-received"), // <p> jeśli brak obrażeń
      // Health & Vitals (List Groups)
      vitalsList: document.getElementById("modal-vitals-list"), // ol dla witalności
      bodypartsList: document.getElementById("modal-bodyparts-list"), // ol dla części ciała
      // Items (List Groups)
      foundItems: document.getElementById("modal-found-items"),
      noFoundItems: document.getElementById("modal-no-found-items"),
      transferItems: document.getElementById("modal-transfer-items"),
      noTransferItems: document.getElementById("modal-no-transfer-items"),
      droppedItems: document.getElementById("modal-dropped-items"),
      noDroppedItems: document.getElementById("modal-no-dropped-items"),
      lostItems: document.getElementById("modal-lost-items"),
      noLostItems: document.getElementById("modal-no-lost-items"),
    };

    // Funkcja pomocnicza do czyszczenia/resetowania modala
    function resetModal() {
      if (modalLoader) modalLoader.classList.remove("d-none");
      if (modalError) modalError.classList.add("d-none");
      if (modalContent) modalContent.classList.add("d-none");
      if (modalTitle) modalTitle.textContent = "Szczegóły rajdu";

      // Resetuj zawartość dynamicznych elementów
      for (const key in elements) {
        const el = elements[key];
        if (!el) continue; // Pomiń, jeśli element nie istnieje

        if (key.startsWith("no")) {
          // dla elementów <p> "Brak..."
          el.classList.add("d-none");
        } else if (
          el.tagName === "TBODY" ||
          el.tagName === "OL" ||
          key === "dmgReceivedDetails"
        ) {
          el.innerHTML = ""; // Wyczyść listy, tabele, kontenery kart
        } else if (key === "killerInfoSection") {
          el.classList.add("d-none"); // Ukryj sekcję zabójcy
        } else if (key === "raidResultCard") {
          el.className = "card-body shadow-lg shadow"; // Reset klasy karty wyniku do bazowej z Twojego HTML
        } else if (
          el.tagName === "DD" ||
          el.tagName === "H2" ||
          el.tagName === "H3" ||
          el.tagName === "SPAN"
        ) {
          el.textContent = "N/A"; // Resetuj tekst w elementach tekstowych
          if (key === "killsCount") el.textContent = "0"; // Specjalny reset dla licznika killi
        }
      }
    }

    // Funkcja do formatowania liczb
    function formatNumber(num) {
      if (num === null || num === undefined) return "N/A";
      // Sprawdź czy to liczba przed formatowaniem
      const numValue = Number(num);
      if (isNaN(numValue)) return num.toString(); // Zwróć jako string jeśli nie jest liczbą
      // Użyj toLocaleString dla separatorów tysięcy
      return numValue.toLocaleString("pl-PL");
    }

    // Funkcja do tworzenia paska postępu (zgodna z Twoją strukturą li dla witalności)
    function createProgressBarVitals(label, current, max) {
      const currentNum = Number(current);
      const maxNum = Number(max);
      if (isNaN(currentNum) || isNaN(maxNum)) return ""; // Pomiń jeśli dane są nieprawidłowe

      const percentage =
        maxNum > 0 ? Math.min(100, (currentNum / maxNum) * 100) : 0;
      const displayValue = `${formatNumber(
        Math.round(currentNum)
      )} / ${formatNumber(maxNum)}`;
      // Używa klas i struktury z Twojego profil-bear.html
      return `
            <li class="list-group-item d-flex justify-content-between align-items-start p-3 shadow">
                <div class="col">
                    <div class="fw-bold fs-4 mb-2">${label}</div>
                    <div class="progress" role="progressbar" aria-valuenow="${currentNum}" aria-valuemin="0" aria-valuemax="${maxNum}">
                        <div class="progress-bar text-bg-info progress-bar-striped progress-bar-animated" style="width: ${percentage}%">${displayValue}</div>
                    </div>
                </div>
            </li>`;
    }

    // Funkcja do tworzenia paska postępu (zgodna z Twoją strukturą li dla części ciała)
    function createProgressBarBody(label, current, max) {
      const currentNum = Number(current);
      const maxNum = Number(max);
      if (isNaN(currentNum) || isNaN(maxNum)) return "";

      const percentage =
        maxNum > 0 ? Math.min(100, (currentNum / maxNum) * 100) : 0;
      const displayValue = `${currentNum.toFixed(1)} / ${maxNum}`; // Formatowanie do 1 miejsca po przecinku
      // Używa klas i struktury z Twojego profil-bear.html
      return `
            <li class="list-group-item d-flex justify-content-between align-items-start p-3 shadow">
                <div class="col">
                    <div class="fw-bold fs-4 mb-2">${label}</div>
                    <div class="progress" role="progressbar" aria-valuenow="${currentNum}" aria-valuemin="0" aria-valuemax="${maxNum}">
                        <div class="progress-bar text-bg-info progress-bar-striped progress-bar-animated" style="width: ${percentage}%">${displayValue}</div>
                    </div>
                </div>
            </li>`;
    }

    // Funkcja do tworzenia listy przedmiotów
    function createItemList(items) {
      if (!items || items.length === 0) return "";
      let html = "";
      items.forEach((item) => {
        // Dodajemy sprawdzenie, czy item i jego właściwości istnieją
        const name = item?.name || "Nieznany przedmiot";
        const count = item?.count || "?";
        html += `<li class="list-group-item">${name} <span class="badge bg-secondary rounded-pill float-end">${count}</span></li>`;
      });
      return html;
    }

    // Funkcja do tworzenia kart dla otrzymanych obrażeń (zgodna z Twoją strukturą)
    function createDamageCard(part, damage) {
      const damageNum = Number(damage);
      if (isNaN(damageNum)) return ""; // Pomiń jeśli obrażenia nie są liczbą
      // Używa klas i struktury z Twojego profil-bear.html
      return `
             <div class="col">
                 <div class="card">
                     <div class="card-body shadow">
                         <h6>${part.toUpperCase()}</h6>
                         <hr>
                         <h3>${formatNumber(damageNum)}</h3>
                     </div>
                 </div>
             </div>`;
    }

    // Event listener dla otwierania modala
    raidDetailsModal.addEventListener("show.bs.modal", function (event) {
      resetModal();
      const button = event.relatedTarget;
      const filename = button.getAttribute("data-filename");

      if (!filename) {
        if (modalLoader) modalLoader.classList.add("d-none");
        if (modalError)
          modalError.classList.remove("d-none").textContent =
            "Błąd: Brak nazwy pliku rajdu.";
        return;
      }

      // Pobierz dane rajdu z API
      fetch(`/api/raid/${filename}`)
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then((data) => {
          if (data.error || !data.data) {
            throw new Error(
              data.error || "Otrzymano nieprawidłowe dane z serwera."
            );
          }
          const raidData = data.data;

          if (modalTitle)
            modalTitle.textContent = `Szczegóły rajdu: ${
              raidData.location || "Nieznana"
            } (${raidData.timestamp_formatted})`;

          // Ofiary (dopasowanie do Twoich nagłówków tabeli)
          if (elements.killsCount)
            elements.killsCount.textContent = raidData.kills_count || 0;
          if (elements.victimsTable && elements.noVictims) {
            if (raidData.victims && raidData.victims.length > 0) {
              let victimsHtml = "";
              raidData.victims.forEach((v, index) => {
                victimsHtml += `
                                <tr>
                                    <th scope="row">${index + 1}</th>
                                    <td>${v.Name || "N/A"}</td>
                                    <td>${v.Level || "N/A"}</td>
                                    <td>${v.SideTranslated || "N/A"}</td>
                                    <td>${
                                      v.WeaponName || "N/A"
                                    }</td> {# GUN -> WeaponName #}
                                    <td>${v.DistanceFormatted || "N/A"}</td>
                                    <td>${
                                      v.BodyPartTranslated || "N/A"
                                    }</td> {# Where -> BodyPartTranslated #}
                                </tr>`;
              });
              elements.victimsTable.innerHTML = victimsHtml;
              elements.noVictims.classList.add("d-none");
            } else {
              elements.victimsTable.innerHTML = "";
              elements.noVictims.classList.remove("d-none");
            }
          }

          // Podstawowe Info (dopasowanie do Twojej struktury kart)
          if (elements.raidResult)
            elements.raidResult.textContent = raidData.raid_result || "N/A";
          if (elements.raidResultCard) {
            // Ustawienie klasy dla karty wyniku
            let resultClass = ""; // Domyślnie brak dodatkowej klasy
            if (raidData.raid_result === "Survived")
              resultClass =
                "text-success-emphasis bg-success-subtle border-success-subtle";
            else if (raidData.raid_result === "Killed")
              resultClass =
                "text-danger-emphasis bg-danger-subtle border-danger-subtle";
            else
              resultClass =
                "text-warning-emphasis bg-warning-subtle border-warning-subtle"; // Dla innych
            // Użyj bazowych klas + dynamicznej klasy wyniku
            elements.raidResultCard.className = `card-body shadow-lg shadow ${resultClass}`;
          }
          if (elements.exitName)
            elements.exitName.textContent =
              raidData.exit_name ||
              (raidData.raid_result === "Survived" ? "N/A" : "---");
          if (elements.survivorClass)
            elements.survivorClass.textContent =
              raidData.survivor_class || "N/A";
          // Poprawiony czas - używa tylko sformatowanej wartości
          if (elements.playTime)
            elements.playTime.textContent =
              raidData.play_time_formatted || "N/A";
          if (elements.playerCount)
            elements.playerCount.textContent =
              raidData.player_count_in_raid || "N/A";

          // Zabójca (wypełnianie pól <dd> w strukturze <dl>)
          if (elements.killerInfoSection) {
            if (raidData.killer_info) {
              elements.killerInfoSection.classList.remove("d-none");
              if (elements.killerName)
                elements.killerName.textContent =
                  raidData.killer_info.name || "Nieznany";
              if (elements.killerRole)
                elements.killerRole.textContent =
                  raidData.killer_info.role_translated || "N/A";
              if (elements.killerSide)
                elements.killerSide.textContent =
                  raidData.killer_info.side || "N/A";
              if (elements.killerWeapon)
                elements.killerWeapon.textContent =
                  raidData.killer_info.weapon_name || "N/A";
              if (elements.killerBodypart)
                elements.killerBodypart.textContent =
                  raidData.killer_info.killed_by_part_translated || "N/A";
              if (elements.killerDamage)
                elements.killerDamage.textContent = raidData.killer_info
                  .lethal_damage_amount
                  ? `${raidData.killer_info.lethal_damage_amount}`
                  : "N/A";
              if (elements.killerDamageType)
                elements.killerDamageType.textContent =
                  raidData.killer_info.lethal_damage_type_translated || "N/A";
            } else {
              elements.killerInfoSection.classList.add("d-none");
            }
          }

          // Statystyki Sesji (dopasowanie do Twoich h3)
          if (elements.expTotal)
            elements.expTotal.textContent = formatNumber(
              raidData.total_session_exp_calculated
            );
          if (elements.expJson)
            elements.expJson.textContent = formatNumber(
              raidData.total_session_exp_from_json
            );
          if (elements.expMult)
            elements.expMult.textContent = `${raidData.session_exp_mult || 1}x`;
          if (elements.expBonus)
            elements.expBonus.textContent = `${
              raidData.experience_bonus_mult || 1
            }x`;
          if (elements.expKill)
            elements.expKill.textContent = formatNumber(
              raidData.session_stats?.exp_kill || 0
            );
          if (elements.expLoot)
            elements.expLoot.textContent = formatNumber(
              raidData.session_stats?.exp_looting || 0
            );
          if (elements.expExit)
            elements.expExit.textContent = formatNumber(
              raidData.session_stats?.exp_exit_status || 0
            );

          // Walka i Ruch (dopasowanie do Twoich h3)
          if (elements.dmgDealt)
            elements.dmgDealt.textContent = formatNumber(
              raidData.session_stats?.damage_dealt || 0
            );
          if (elements.dmgReceived)
            elements.dmgReceived.textContent = formatNumber(
              raidData.session_stats?.damage_received_total || 0
            );
          if (elements.distance)
            elements.distance.textContent =
              raidData.session_stats?.distance_formatted || "N/A";
          if (elements.bloodloss)
            elements.bloodloss.textContent = formatNumber(
              raidData.session_stats?.blood_loss || 0
            );
          if (elements.deaths)
            elements.deaths.textContent = formatNumber(
              raidData.session_stats?.deaths || 0
            );

          // Otrzymane Obrażenia - Szczegóły (generowanie kart zgodnych z Twoją strukturą)
          if (elements.dmgReceivedDetails && elements.noDmgReceived) {
            const details = raidData.session_stats?.damage_received_details;
            if (details && Object.keys(details).length > 0) {
              let dmgDetailsHtml = "";
              const orderedPartsDmg = [
                "Głowa",
                "Klatka piersiowa",
                "Brzuch",
                "Lewa ręka",
                "Prawa ręka",
                "Lewa noga",
                "Prawa noga",
              ];
              orderedPartsDmg.forEach((partName) => {
                if (details[partName] !== undefined) {
                  // Sprawdź czy klucz istnieje
                  dmgDetailsHtml += createDamageCard(
                    partName,
                    details[partName]
                  );
                }
              });
              for (const [part, dmg] of Object.entries(details)) {
                if (!orderedPartsDmg.includes(part)) {
                  dmgDetailsHtml += createDamageCard(part, dmg);
                }
              }
              elements.dmgReceivedDetails.innerHTML = dmgDetailsHtml;
              elements.noDmgReceived.classList.add("d-none");
            } else {
              elements.dmgReceivedDetails.innerHTML = "";
              elements.noDmgReceived.classList.remove("d-none");
            }
          }

          // Witalność (użycie Twojej funkcji paska)
          if (elements.vitalsList) {
            let vitalsHtml = "";
            const vitals = raidData.final_vitals;
            if (vitals) {
              vitalsHtml += createProgressBarVitals(
                "Energia",
                vitals.Energy,
                vitals.MaxEnergy
              );
              vitalsHtml += createProgressBarVitals(
                "Nawodnienie",
                vitals.Hydration,
                vitals.MaxHydration
              );
              // Dostosuj max dla Temp i Poison jeśli trzeba
              vitalsHtml += createProgressBarVitals(
                "Temperatura",
                vitals.Temperature,
                50
              );
              vitalsHtml += createProgressBarVitals(
                "Trucizna",
                vitals.Poison,
                100
              );
            }
            elements.vitalsList.innerHTML =
              vitalsHtml || '<li class="list-group-item">Brak danych</li>';
          }

          // Zdrowie Części Ciała (użycie Twojej funkcji paska)
          if (elements.bodypartsList) {
            let bodypartsHtml = "";
            const health = raidData.final_health;
            if (health && Object.keys(health).length > 0) {
              const orderedParts = [
                "Głowa",
                "Klatka piersiowa",
                "Brzuch",
                "Lewa ręka",
                "Prawa ręka",
                "Lewa noga",
                "Prawa noga",
              ];
              orderedParts.forEach((partName) => {
                if (health[partName]) {
                  const part = health[partName];
                  let label = partName;
                  if (part.effects && part.effects.length > 0) {
                    label += ` <small class="text-warning">(${part.effects.join(
                      ", "
                    )})</small>`;
                  }
                  bodypartsHtml += createProgressBarBody(
                    label,
                    part.current,
                    part.maximum
                  );
                }
              });
              for (const partName in health) {
                if (!orderedParts.includes(partName)) {
                  const part = health[partName];
                  let label = partName;
                  if (part.effects && part.effects.length > 0) {
                    label += ` <small class="text-warning">(${part.effects.join(
                      ", "
                    )})</small>`;
                  }
                  bodypartsHtml += createProgressBarBody(
                    label,
                    part.current,
                    part.maximum
                  );
                }
              }
            }
            elements.bodypartsList.innerHTML =
              bodypartsHtml || '<li class="list-group-item">Brak danych</li>';
          }

          // Przedmioty
          const itemLists = {
            foundItems: raidData.found_in_raid_items,
            transferItems: raidData.transfer_items,
            droppedItems: raidData.dropped_items,
            lostItems: raidData.lost_insured_items,
          };
          for (const [key, items] of Object.entries(itemLists)) {
            const listElement = elements[key];
            const noItemsElement =
              elements[`no${key.charAt(0).toUpperCase() + key.slice(1)}`];
            if (listElement && noItemsElement) {
              if (items && items.length > 0) {
                listElement.innerHTML = createItemList(items);
                noItemsElement.classList.add("d-none");
              } else {
                listElement.innerHTML = "";
                noItemsElement.classList.remove("d-none");
              }
            } else {
              console.warn(`Missing elements for item list: ${key}`);
            }
          }

          // Pokaż zawartość, ukryj loader
          if (modalLoader) modalLoader.classList.add("d-none");
          if (modalContent) modalContent.classList.remove("d-none");
        })
        .catch((error) => {
          console.error("Error fetching raid details:", error);
          if (modalLoader) modalLoader.classList.add("d-none");
          if (modalError)
            modalError.classList.remove(
              "d-none"
            ).textContent = `Błąd ładowania danych: ${error.message}`;
        });
    });
  });
</script>
{% endblock %}
