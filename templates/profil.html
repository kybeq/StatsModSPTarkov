{% extends "base.html" %} {% block title %}Profil Gracza: {{ nickname }} -
StatsMods Tarkov{% endblock %} {% block content %} {% if player_info %}
<section
  class="{% if player_info.latest_side == 'Bear' or player_info.latest_side == 'BEAR' or player_info.latest_side == 'bear' %}bear{% elif player_info.latest_side == 'Usec' or player_info.latest_side == 'USEC' or player_info.latest_side == 'usec' %}usec{% else %}default-profile{% endif %}"
>
  {# Górne karty z informacjami o graczu #}
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card h-100">
        <div
          class="card-body shadow-lg {% if player_info.latest_side == 'Bear' or player_info.latest_side == 'BEAR' or player_info.latest_side == 'bear' %}text-danger-emphasis bg-danger-subtle border-danger-subtle{% else %}text-primary-emphasis bg-primary-subtle border-primary-subtle{% endif %}"
        >
          <h5>Name</h5>
          <h1>{{ nickname }}</h1>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100">
        <div
          class="card-body shadow {% if player_info.latest_side == 'Bear' or player_info.latest_side == 'BEAR' or player_info.latest_side == 'bear' %}text-danger-emphasis bg-danger-subtle border-danger-subtle{% else %}text-primary-emphasis bg-primary-subtle border-primary-subtle{% endif %}"
        >
          <h5>Frakcja</h5>
          <h1>{{ get_item_name(player_info.latest_side) }}</h1>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100">
        <div
          class="card-body shadow {% if player_info.latest_side == 'Bear' or player_info.latest_side == 'BEAR' or player_info.latest_side == 'bear' %}text-danger-emphasis bg-danger-subtle border-danger-subtle{% else %}text-primary-emphasis bg-primary-subtle border-primary-subtle{% endif %}"
        >
          <h5>Poziom</h5>
          <h1>{{ player_info.latest_level or 'N/A' }}</h1>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100">
        <div
          class="card-body shadow {% if player_info.latest_side == 'Bear' or player_info.latest_side == 'BEAR' or player_info.latest_side == 'bear' %}text-danger-emphasis bg-danger-subtle border-danger-subtle{% else %}text-primary-emphasis bg-primary-subtle border-primary-subtle{% endif %}"
        >
          <h5>Total EXP (z rajdów)</h5>
          <h1>{{ player_info.latest_total_experience_formatted }}</h1>
        </div>
      </div>
    </div>
  </div>

  {# Drugi rząd kart ze statystykami #}
  <div class="row g-3 my-1 mb-4">
    <div class="col">
      <div class="card h-100">
        <div
          class="card-body shadow text-info-emphasis bg-info-subtle border border-info-subtle"
        >
          <h5>Sesje</h5>
          <h2>{{ player_stats.sessions }}</h2>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100">
        <div
          class="card-body shadow text-success-emphasis bg-success-subtle border border-success-subtle"
        >
          <h5>Przeżyte</h5>
          <h2>{{ player_stats.survived_sessions }}</h2>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100">
        <div
          class="card-body shadow text-danger-emphasis bg-danger-subtle border border-danger-subtle"
        >
          <h5>Śmierci</h5>
          <h2>{{ player_stats.deaths }}</h2>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100">
        <div
          class="card-body shadow text-info-emphasis bg-info-subtle border border-info-subtle"
        >
          <h5>Zabójstwa</h5>
          <h2>{{ player_stats.kills }}</h2>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100">
        <div
          class="card-body shadow text-info-emphasis bg-info-subtle border border-info-subtle"
        >
          <h5>Survival Rate</h5>
          <h2>{{ player_stats.survival_rate }}</h2>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100">
        <div
          class="card-body shadow text-info-emphasis bg-info-subtle border border-info-subtle"
        >
          <h5>K/D Ratio</h5>
          <h2>{{ player_stats.kd_ratio }}</h2>
        </div>
      </div>
    </div>
  </div>
  <hr class="col col-md-12 my-5" />
  <div class="row g-5">
    <div class="col-md-4 col-sm-12 border-end">
      <h1 class="mb-5">Ostatni rajd</h1>
      {% if latest_raid %}
      <div class="card mb-3 shadow-lg">
        {% if latest_raid.location %}
        <img
          src="{{ url_for('static', filename=get_map_image_url(latest_raid.location)) }}"
          class="img-fluid"
          alt="{{ latest_raid.location }}"
        />
        {% else %}
        <img
          src="{{ url_for('static', filename=get_map_image_url('unknown')) }}"
          class="img-fluid"
          alt="Nieznana mapa"
        />
        {% endif %}
        <div class="card-body">
          <h3 class="card-title">{{ latest_raid.location or 'Nieznana' }}</h3>
          <p class="card-text">
            <small class="text-body-secondary"
              >Zakończono: {{ latest_raid.timestamp_formatted }}</small
            >
          </p>
        </div>
        <ul class="list-group list-group-flush">
          <li
            class="list-group-item p-3 {% if latest_raid.raid_result == get_item_name('Survived') or latest_raid.raid_result|lower == 'przetrwano' %}text-success-emphasis bg-success-subtle border-success-subtle{% elif latest_raid.raid_result == get_item_name('Killed') or latest_raid.raid_result|lower == 'zabity' %}text-danger-emphasis bg-danger-subtle border-danger-subtle{% else %}text-warning-emphasis bg-warning-subtle border-warning-subtle{% endif %}"
          >
            <small>Status</small>
            <h3>{{ latest_raid.raid_result or 'N/A' }}</h3>
          </li>
          <li class="list-group-item p-3">
            <small>Czas</small>
            <h3>{{ latest_raid.play_time_formatted }}</h3>
          </li>
          <ul class="list-group list-group-horizontal">
            <li class="list-group-item col border border-0">
              <small>Zabójstwa w rajdzie</small>
              <h4>{{ latest_raid.kills_count }}</h4>
            </li>
            <li class="list-group-item col border border-0">
              <small>Wyjście</small>
              <h4>
                {{ latest_raid.exit_name if (latest_raid.raid_result ==
                get_item_name('Survived') or latest_raid.raid_result|lower ==
                'przetrwano') else '---' }}
              </h4>
            </li>
          </ul>
        </ul>
      </div>
      {% else %}
      <p>Brak danych o ostatnim rajdzie tego gracza.</p>
      {% endif %}
    </div>
    <div class="col-md-8 col-sm-12">
      <h1 class="mb-5">Ostatnie rajdy</h1>
      {% if player_raids %}
      <div class="table-responsive">
        <table class="table table-striped text-center">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Data</th>
              <th scope="col">Mapa</th>
              <th scope="col">Wynik</th>
              <th scope="col">Czas</th>
              <th scope="col">Kille</th>
              <th scope="col">EXP (Sesja)</th>
              <th scope="col">Szczegóły</th>
            </tr>
          </thead>
          <tbody>
            {% for raid in player_raids %}
            <tr>
              <th scope="row">{{ loop.index }}</th>
              <td>{{ raid.timestamp_formatted }}</td>
              <td>{{ raid.location or 'N/A' }}</td>
              <td>{{ raid.raid_result or 'N/A' }}</td>
              <td>{{ raid.play_time_formatted }}</td>
              <td>{{ raid.kills_count }}</td>
              <td>{{ format_exp(raid.total_session_exp_calculated) }}</td>
              <td>
                <button
                  type="button"
                  class="btn btn-secondary btn-sm open-raid-modal"
                  data-bs-toggle="modal"
                  data-bs-target="#raidDetailsModal"
                  data-jsonpath-relative="{{ raid.data_json_path_relative }}"
                >
                  zobacz
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p>Brak historii rajdów dla tego gracza.</p>
      {% endif %}
    </div>
  </div>

  {# Sekcje tylko dla BEAR - lub usuń warunek, jeśli dla wszystkich #} {# {% if
  player_info.latest_side == 'bear' or player_info.latest_side == 'Bear' %} #}
  <hr class="col col-md-12 my-5" />
  <section>
    <div class="row">
      <div class="col">
        <h1 class="mb-5">Umiejętności (z ostatniego rajdu gracza)</h1>
      </div>
    </div>
    {% if skills and skills|length > 0 %}
    <div class="row g-3">
      <div class="col-md-6">
        {# Użyj col-md-6 dla lepszego układu na większych ekranach #}
        <h4 class="mb-1 card p-3">Common</h4>
        <ol class="list-group">
          {% for skill in skills if skill.SkillType == 'Common' %}
          <li
            class="list-group-item d-flex justify-content-between align-items-start p-3 gap-5 shadow"
          >
            <div class="col">
              <div class="fw-bold fs-4 mb-2">{{ skill.SkillName }}</div>
              <div
                class="progress"
                role="progressbar"
                aria-valuenow="{{ skill.Progress|float }}"
                aria-valuemin="0"
                aria-valuemax="100"
                style="height: 20px"
              >
                <div
                  class="progress-bar text-bg-info progress-bar-striped progress-bar-animated"
                  style="width: {{ skill.Progress|float }}%"
                >
                  {{ skill.ProgressFormatted }}
                </div>
              </div>
            </div>
            <span class="badge text-bg-info border-0 p-3 fs-6"
              >+{{ skill.PointsEarnedFormatted }}</span
            >
          </li>
          {% else %}
          <li class="list-group-item">
            Brak zmian w umiejętnościach Common w ostatnim rajdzie.
          </li>
          {% endfor %}
        </ol>
      </div>
      <div class="col-md-6">
        <h4 class="mb-1 card p-3">Mastering</h4>
        <ol class="list-group">
          {% for skill in skills if skill.SkillType == 'Mastering' %}
          <li
            class="list-group-item d-flex justify-content-between align-items-start p-3 gap-5 shadow"
          >
            <div class="col">
              <div class="fw-bold fs-4 mb-2">{{ skill.SkillName }}</div>
              <div
                class="progress"
                role="progressbar"
                aria-valuenow="{{ skill.Progress|float }}"
                aria-valuemin="0"
                aria-valuemax="100"
                style="height: 20px"
              >
                <div
                  class="progress-bar text-bg-warning progress-bar-striped progress-bar-animated"
                  style="width: {{ skill.Progress|float }}%"
                >
                  {{ skill.ProgressFormatted }}
                </div>
              </div>
            </div>
            <span class="badge text-bg-warning border-0 p-3 fs-6">
              {% if skill.PointsEarnedFormatted != 'N/A' and
              skill.PointsEarnedFormatted != '0.00' and
              skill.PointsEarnedFormatted != '0' %} +{{
              skill.PointsEarnedFormatted }} {% else %} Poziom {{
              skill.ProgressFormatted }} {% endif %}
            </span>
          </li>
          {% else %}
          <li class="list-group-item">
            Brak zmian w umiejętnościach Mastering w ostatnim rajdzie.
          </li>
          {% endfor %}
        </ol>
      </div>
    </div>
    {% else %}
    <p>Brak danych o zmianach umiejętności w ostatnim rajdzie tego gracza.</p>
    {% endif %}
  </section>

  <hr class="col col-md-12 my-5" />
  <section>
    <div class="row">
      <div class="col">
        <h1 class="mb-5">Osiągnięcia (z profilu gracza)</h1>
      </div>
    </div>
    <div class="row g-3">
      {% if achievements and achievements|length > 0 %} {% for achievement in
      achievements %}
      <div class="col-md-auto">
        <div class="card text-center shadow" style="width: 10rem">
          <img
            src="{{ url_for('static', filename='achievements/' + (achievement.id if achievement.id else 'unknown') + '.png') }}"
            class="card-img p-2"
            alt="{{ achievement.name }}"
            onerror="this.onerror=null; this.src='{{ url_for('static', filename='achievements/unknown.png') }}';"
          />
          <div class="card-body py-2">
            <h6
              class="card-title small"
              data-bs-toggle="tooltip"
              data-bs-placement="top"
              title="Zdobyto: {{ achievement.timestamp if achievement.timestamp != 'N/A' else 'Brak daty' }}"
            >
              {{ achievement.name }}
            </h6>
          </div>
        </div>
      </div>
      {% endfor %} {% else %}
      <div class="col">
        <p>Brak osiągnięć do wyświetlenia dla tego gracza.</p>
      </div>
      {% endif %}
    </div>
  </section>
  {# {% endif %} #} {# Koniec warunku if player_info.latest_side == 'bear' #}
</section>

{# Modal "Szczegóły Rajdu" #}
<div
  class="modal fade"
  id="raidDetailsModal"
  tabindex="-1"
  aria-labelledby="raidDetailsModalLabel"
  aria-hidden="true"
>
  <div
    class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl"
  >
    <div class="modal-content rounded-0 p-3">
      <div class="modal-header border-0">
        <h1 class="modal-title fs-4" id="raidDetailsModalLabel">
          Szczegóły rajdu
        </h1>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body" id="raidModalBody">
        <div class="d-flex justify-content-center my-5" id="modalLoader">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Ładowanie...</span>
          </div>
        </div>
        <div class="alert alert-danger d-none" role="alert" id="modalError">
          Nie udało się załadować danych rajdu.
        </div>
        <div id="modalContent" class="d-none">
          <h4 class="mb-3">
            Ofiary gracza (<span id="modal-kills-count">0</span>)
          </h4>
          <div class="table-responsive mb-4">
            <table class="table table-striped text-center">
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">Name</th>
                  <th scope="col">LVL</th>
                  <th scope="col">Frakcja</th>
                  <th scope="col">GUN</th>
                  <th scope="col">Distance</th>
                  <th scope="col">Where</th>
                </tr>
              </thead>
              <tbody id="modal-victims-table"></tbody>
            </table>
            <p id="modal-no-victims" class="text-center text-muted d-none">
              Brak ofiar w tym rajdzie.
            </p>
          </div>
          <div class="row g-3 mb-4">
            <div class="col">
              <div class="card">
                <div
                  class="card-body shadow-lg shadow"
                  id="modal-raid-result-card"
                >
                  <h5>Wynik</h5>
                  <hr />
                  <h2 id="modal-raid-result">N/A</h2>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h5>Wyjście</h5>
                  <hr />
                  <h2 id="modal-exit-name">N/A</h2>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h5>Klasa</h5>
                  <hr />
                  <h2 id="modal-survivor-class">N/A</h2>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h5>Czas</h5>
                  <hr />
                  <h2 id="modal-play-time">N/A</h2>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h5>Graczy (w rajdzie)</h5>
                  <hr />
                  <h2 id="modal-player-count">N/A</h2>
                </div>
              </div>
            </div>
          </div>
          <div id="modal-killer-info-section" class="mb-4 d-none">
            <h4 class="mb-3 text-danger">Informacje o zabójcy</h4>
            <div class="row g-3">
              <div class="col">
                <div class="card h-100 bg-danger-subtle border-danger">
                  <div class="card-body shadow">
                    <h5>Nick</h5>
                    <hr />
                    <h2 id="modal-killer-name">N/A</h2>
                  </div>
                </div>
              </div>
              <div class="col">
                <div class="card h-100 bg-danger-subtle border-danger">
                  <div class="card-body shadow">
                    <h5>Rola</h5>
                    <hr />
                    <h2 id="modal-killer-role">N/A</h2>
                  </div>
                </div>
              </div>
              <div class="col">
                <div class="card h-100 bg-danger-subtle border-danger">
                  <div class="card-body shadow">
                    <h5>Frakcja</h5>
                    <hr />
                    <h2 id="modal-killer-side">N/A</h2>
                  </div>
                </div>
              </div>
              <div class="col">
                <div class="card h-100 bg-danger-subtle border-danger">
                  <div class="card-body shadow">
                    <h5>Broń</h5>
                    <hr />
                    <h2 id="modal-killer-weapon">N/A</h2>
                  </div>
                </div>
              </div>
              <div class="col">
                <div class="card h-100 bg-danger-subtle border-danger">
                  <div class="card-body shadow">
                    <h5>Trafienie</h5>
                    <hr />
                    <h2 id="modal-killer-bodypart">N/A</h2>
                  </div>
                </div>
              </div>
              <div class="col">
                <div class="card h-100 bg-danger-subtle border-danger">
                  <div class="card-body shadow">
                    <h5>Obrażenia (lethal)</h5>
                    <hr />
                    <h2 id="modal-killer-damage">N/A</h2>
                  </div>
                </div>
              </div>
              <div class="col">
                <div class="card h-100 bg-danger-subtle border-danger">
                  <div class="card-body shadow">
                    <h5>Typ Obrażeń (lethal)</h5>
                    <hr />
                    <h2 id="modal-killer-damagetype">N/A</h2>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <h5 class="py-3">Statystyki Sesji</h5>
          <div class="row g-3 mt-1">
            <div class="col">
              <div class="card">
                <div class="card-body shadow-lg">
                  <h6>EXP (Suma K+L+E)</h6>
                  <hr />
                  <h3 id="modal-exp-total">0</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>EXP (TotalSession)</h6>
                  <hr />
                  <h3 id="modal-exp-json">0</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>Mnożnik EXP</h6>
                  <hr />
                  <h3 id="modal-exp-mult">1x</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>Bonus EXP</h6>
                  <hr />
                  <h3 id="modal-exp-bonus">1x</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>EXP Zabójstwa</h6>
                  <hr />
                  <h3 id="modal-exp-kill">0</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>EXP Przeszuk.</h6>
                  <hr />
                  <h3 id="modal-exp-loot">0</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>EXP Wyjścia</h6>
                  <hr />
                  <h3 id="modal-exp-exit">0</h3>
                </div>
              </div>
            </div>
          </div>
          <h5 class="py-3">Walka i Ruch</h5>
          <div class="row g-3 mt-1">
            <div class="col">
              <div class="card">
                <div class="card-body shadow-lg">
                  <h6>Obraż. Zadane</h6>
                  <hr />
                  <h3 id="modal-dmg-dealt">0</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>Obraż. Otrzymane</h6>
                  <hr />
                  <h3 id="modal-dmg-received">0</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>Dystans (Pedometer)</h6>
                  <hr />
                  <h3 id="modal-distance">0 m</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>Utrata Krwi</h6>
                  <hr />
                  <h3 id="modal-bloodloss">0</h3>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card">
                <div class="card-body shadow">
                  <h6>Śmierci (w Sesji)</h6>
                  <hr />
                  <h3 id="modal-deaths">0</h3>
                </div>
              </div>
            </div>
          </div>
          <h5 class="py-3">Otrzymane Obrażenia (szczegóły)</h5>
          <div class="row g-3 mt-1" id="modal-dmg-received-details">
            <p id="modal-no-dmg-received" class="text-center text-muted d-none">
              Brak otrzymanych obrażeń.
            </p>
          </div>
          <div class="row mt-5">
            <div class="col-md-6">
              <h4 class="mb-1 card p-3">Końcowe Zdrowie i Witalność</h4>
              <ol class="list-group" id="modal-vitals-list"></ol>
            </div>
            <div class="col-md-6">
              <h4 class="mb-1 card p-3">Zdrowie Części Ciała</h4>
              <ol class="list-group" id="modal-bodyparts-list"></ol>
            </div>
          </div>
          <hr class="my-5" />
          <h4 class="mb-3">Umiejętności (zmiany w sesji / wszystkie)</h4>
          {# Zmieniono tytuł #}
          <div id="modal-skills-section">
            <p id="modal-no-skills-changed" class="text-muted d-none">
              Brak danych o umiejętnościach.
            </p>
          </div>
          <hr class="my-5" />
          <div class="row mt-4">
            <div class="col-md-6 mb-4">
              <h4 class="mb-3">Znalezione w Rajdzie</h4>
              <ul
                class="list-group list-group-flush"
                id="modal-found-items"
              ></ul>
              <p id="modal-no-found-items" class="text-muted d-none">Brak</p>
            </div>
            <div class="col-md-6 mb-4">
              <h4 class="mb-3">Przeniesione (loot Scava)</h4>
              <ul
                class="list-group list-group-flush"
                id="modal-transfer-items"
              ></ul>
              <p id="modal-no-transfer-items" class="text-muted d-none">Brak</p>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-4">
              <h4 class="mb-3">Upuszczone</h4>
              <ul
                class="list-group list-group-flush"
                id="modal-dropped-items"
              ></ul>
              <p id="modal-no-dropped-items" class="text-muted d-none">Brak</p>
            </div>
            <div class="col-md-6 mb-4">
              <h4 class="mb-3">Stracone Ubezpieczone</h4>
              <ul
                class="list-group list-group-flush"
                id="modal-lost-items"
              ></ul>
              <p id="modal-no-lost-items" class="text-muted d-none">Brak</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% else %}
<div class="alert alert-danger" role="alert">
  Nie znaleziono informacji o graczu: {{ nickname }}
</div>
{% endif %} {% endblock %} {% block scripts %} {{ super() }}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const raidDetailsModal = document.getElementById("raidDetailsModal");
    if (!raidDetailsModal) {
      console.error("MODAL SCRIPT: Element #raidDetailsModal nie znaleziony!");
      return;
    }

    const modalLoader = document.getElementById("modalLoader");
    const modalError = document.getElementById("modalError");
    const modalContent = document.getElementById("modalContent");
    const modalTitle = document.getElementById("raidDetailsModalLabel");

    const elements = {
      killsCount: document.getElementById("modal-kills-count"),
      victimsTable: document.getElementById("modal-victims-table"),
      noVictims: document.getElementById("modal-no-victims"),
      raidResult: document.getElementById("modal-raid-result"),
      raidResultCard: document.getElementById("modal-raid-result-card"),
      exitName: document.getElementById("modal-exit-name"),
      survivorClass: document.getElementById("modal-survivor-class"),
      playTime: document.getElementById("modal-play-time"),
      playerCount: document.getElementById("modal-player-count"),
      killerInfoSection: document.getElementById("modal-killer-info-section"),
      killerName: document.getElementById("modal-killer-name"),
      killerRole: document.getElementById("modal-killer-role"),
      killerSide: document.getElementById("modal-killer-side"),
      killerWeapon: document.getElementById("modal-killer-weapon"),
      killerBodypart: document.getElementById("modal-killer-bodypart"),
      killerDamage: document.getElementById("modal-killer-damage"),
      killerDamageType: document.getElementById("modal-killer-damagetype"),
      expTotal: document.getElementById("modal-exp-total"),
      expJson: document.getElementById("modal-exp-json"),
      expMult: document.getElementById("modal-exp-mult"),
      expBonus: document.getElementById("modal-exp-bonus"),
      expKill: document.getElementById("modal-exp-kill"),
      expLoot: document.getElementById("modal-exp-loot"),
      expExit: document.getElementById("modal-exp-exit"),
      dmgDealt: document.getElementById("modal-dmg-dealt"),
      dmgReceived: document.getElementById("modal-dmg-received"),
      distance: document.getElementById("modal-distance"),
      bloodloss: document.getElementById("modal-bloodloss"),
      deaths: document.getElementById("modal-deaths"),
      dmgReceivedDetails: document.getElementById("modal-dmg-received-details"),
      noDmgReceived: document.getElementById("modal-no-dmg-received"),
      vitalsList: document.getElementById("modal-vitals-list"),
      bodypartsList: document.getElementById("modal-bodyparts-list"),
      skillsSection: document.getElementById("modal-skills-section"),
      noSkillsChanged: document.getElementById("modal-no-skills-changed"),
      foundItems: document.getElementById("modal-found-items"),
      noFoundItems: document.getElementById("modal-no-found-items"),
      transferItems: document.getElementById("modal-transfer-items"),
      noTransferItems: document.getElementById("modal-no-transfer-items"),
      droppedItems: document.getElementById("modal-dropped-items"),
      noDroppedItems: document.getElementById("modal-no-dropped-items"),
      lostItems: document.getElementById("modal-lost-items"),
      noLostItems: document.getElementById("modal-no-lost-items"),
    };

    function setText(element, value, defaultValue = "N/A") {
      if (element) {
        element.textContent =
          value !== null && value !== undefined && value !== ""
            ? value
            : defaultValue;
      } else {
        // console.warn("setText: Próba ustawienia tekstu na nieistniejącym elemencie.");
      }
    }
    function setHtml(element, htmlContent) {
      if (element) {
        element.innerHTML = htmlContent;
      } else {
        // console.warn("setHtml: Próba ustawienia HTML na nieistniejącym elemencie.");
      }
    }

    function resetModal() {
      if (modalLoader) modalLoader.classList.remove("d-none");
      if (modalError) modalError.classList.add("d-none");
      if (modalContent) modalContent.classList.add("d-none");
      setText(modalTitle, "Szczegóły rajdu");
      for (const key in elements) {
        const el = elements[key];
        if (!el) continue;
        if (key.startsWith("no")) el.classList.add("d-none");
        else if (
          el.tagName === "TBODY" ||
          el.tagName === "OL" ||
          key === "dmgReceivedDetails" ||
          key === "skillsSection"
        )
          el.innerHTML = "";
        else if (key === "killerInfoSection") el.classList.add("d-none");
        else if (key === "raidResultCard")
          el.className = "card-body shadow-lg shadow";
        else {
          // Dla H2, H3, SPAN itp.
          setText(el, "N/A");
          if (key === "killsCount") setText(el, "0");
        }
      }
    }

    function formatNumberForJS(num) {
      // Zmieniono nazwę, aby uniknąć konfliktu z Jinja
      if (num === null || num === undefined || num === "") return "0";
      const numValue = Number(num);
      if (isNaN(numValue)) {
        // Jeśli nie jest liczbą, spróbuj usunąć spacje i ponownie
        const cleanedNum = String(num).replace(/\s/g, "");
        const cleanedNumValue = Number(cleanedNum);
        if (isNaN(cleanedNumValue)) return String(num); // Zwróć oryginał, jeśli nadal nie jest liczbą
        return cleanedNumValue
          .toLocaleString("pl-PL", { useGrouping: true })
          .replace(/,/g, " ");
      }
      return numValue
        .toLocaleString("pl-PL", { useGrouping: true })
        .replace(/,/g, " ");
    }

    function createProgressBarVitals(label, current, max) {
      const currentNum = Number(current);
      const maxNum = Number(max);
      if (isNaN(currentNum) || isNaN(maxNum) || maxNum <= 0)
        return `<li class="list-group-item">${label}: N/A</li>`;
      const percentage = Math.min(100, (currentNum / maxNum) * 100);
      const displayValue = `${formatNumberForJS(
        Math.round(currentNum)
      )} / ${formatNumberForJS(maxNum)}`;
      return `<li class="list-group-item d-flex justify-content-between align-items-start p-3 shadow"><div class="col"><div class="fw-bold fs-4 mb-2">${label}</div><div class="progress" role="progressbar" aria-valuenow="${currentNum}" aria-valuemin="0" aria-valuemax="${maxNum}" style="height: 20px;"><div class="progress-bar text-bg-info progress-bar-striped progress-bar-animated" style="width: ${percentage}%">${displayValue}</div></div></div></li>`;
    }

    function createProgressBarBody(label, current, max, effects = []) {
      const currentNum = Number(current);
      const maxNum = Number(max);
      if (isNaN(currentNum) || isNaN(maxNum) || maxNum <= 0)
        return `<li class="list-group-item">${label}: N/A</li>`;
      const percentage = Math.min(100, (currentNum / maxNum) * 100);
      const displayValue = `${currentNum.toFixed(1)} / ${maxNum}`;
      let effectsHtml = "";
      if (
        effects &&
        effects.length > 0 &&
        effects.some((e) => e && e.trim() !== "" && e.trim() !== "N/A")
      ) {
        effectsHtml = ` <small class="text-warning">(${effects
          .filter((e) => e && e.trim() !== "" && e.trim() !== "N/A")
          .join(", ")})</small>`;
      }
      return `<li class="list-group-item d-flex justify-content-between align-items-start p-3 shadow"><div class="col"><div class="fw-bold fs-4 mb-2">${label}${effectsHtml}</div><div class="progress" role="progressbar" aria-valuenow="${currentNum}" aria-valuemin="0" aria-valuemax="${maxNum}" style="height: 20px;"><div class="progress-bar text-bg-info progress-bar-striped progress-bar-animated" style="width: ${percentage}%">${displayValue}</div></div></div></li>`;
    }

    function createItemListJS(items, listElementId) {
      // Zmieniono nazwę
      const listElement = document.getElementById(listElementId);
      const noItemsElementId = `no${
        listElementId.substring(5).charAt(0).toUpperCase() +
        listElementId.substring(6)
      }`;
      const noItemsElement = document.getElementById(noItemsElementId);

      if (!listElement || !noItemsElement) {
        return;
      }
      if (!items || items.length === 0) {
        listElement.innerHTML = "";
        noItemsElement.classList.remove("d-none");
        return;
      }
      let html = "";
      items.forEach((item) => {
        const name = item?.name || "Nieznany przedmiot";
        const count = item?.count || "?";
        html += `<li class="list-group-item">${name} <span class="badge bg-secondary rounded-pill float-end">${count}</span></li>`;
      });
      listElement.innerHTML = html;
      noItemsElement.classList.add("d-none");
    }

    function createDamageCard(part, damage) {
      const damageNum = Number(damage);
      if (isNaN(damageNum)) return "";
      return `<div class="col"><div class="card"><div class="card-body shadow"><h6>${part.toUpperCase()}</h6><hr><h3>${formatNumberForJS(damageNum)}</h3></div></div></div>`;
    }

    raidDetailsModal.addEventListener("show.bs.modal", function (event) {
      resetModal();
      const button = event.relatedTarget;
      const jsonPathRelative = button.getAttribute("data-jsonpath-relative");

      if (!jsonPathRelative) {
        if (modalLoader) modalLoader.classList.add("d-none");
        if (modalError)
          modalError.classList.remove("d-none").textContent =
            "Błąd: Brak ścieżki do pliku JSON rajdu (atrybut data-jsonpath-relative).";
        return;
      }

      const apiUrl = `/api/raid_json_details?path=${encodeURIComponent(
        jsonPathRelative
      )}`;
      setText(modalTitle, `Ładowanie szczegółów rajdu...`);
      if (modalLoader) modalLoader.classList.remove("d-none");

      fetch(apiUrl)
        .then((response) => {
          if (!response.ok) {
            return response.text().then((text) => {
              throw new Error(
                `HTTP error! Status: ${response.status}, URL: ${apiUrl}, Odpowiedź serwera: ${text}`
              );
            });
          }
          return response.json();
        })
        .then((apiResponse) => {
          if (apiResponse.error || !apiResponse.data) {
            throw new Error(
              apiResponse.error ||
                "API zwróciło nieprawidłowe dane lub brak danych. Szczegóły: " +
                  JSON.stringify(apiResponse)
            );
          }
          const raidData = apiResponse.data;

          setText(
            modalTitle,
            `Szczegóły rajdu: ${raidData.location || "Nieznana"} (${
              raidData.timestamp_formatted || "Brak daty"
            })`
          );

          setText(elements.killsCount, raidData.kills_count);
          if (elements.victimsTable && elements.noVictims) {
            if (raidData.victims && raidData.victims.length > 0) {
              let victimsHtml = "";
              raidData.victims.forEach((v, index) => {
                victimsHtml += `<tr><th scope="row">${index + 1}</th><td>${
                  v.Name || "N/A"
                }</td><td>${v.Level || "N/A"}</td><td>${
                  v.RoleTranslated || "N/A"
                }</td><td>${v.WeaponName || "N/A"}</td><td>${
                  v.DistanceFormatted || "N/A"
                }</td><td>${v.BodyPartTranslated || "N/A"}</td></tr>`;
              });
              setHtml(elements.victimsTable, victimsHtml);
              elements.noVictims.classList.add("d-none");
            } else {
              setHtml(elements.victimsTable, "");
              elements.noVictims.classList.remove("d-none");
            }
          }

          setText(elements.raidResult, raidData.raid_result);
          if (elements.raidResultCard) {
            let resultClass =
              "text-warning-emphasis bg-warning-subtle border-warning-subtle";
            const raidResultLower = (raidData.raid_result || "").toLowerCase();
            const survivedName = (
              "{{ get_item_name('Survived') }}" || "Survived"
            ).toLowerCase();
            const killedName = (
              "{{ get_item_name('Killed') }}" || "Killed"
            ).toLowerCase();
            if (
              raidResultLower === survivedName ||
              raidResultLower === "przetrwano"
            )
              resultClass =
                "text-success-emphasis bg-success-subtle border-success-subtle";
            else if (
              raidResultLower === killedName ||
              raidResultLower === "zabity"
            )
              resultClass =
                "text-danger-emphasis bg-danger-subtle border-danger-subtle";
            elements.raidResultCard.className = `card-body shadow-lg shadow ${resultClass}`;
          }
          setText(elements.exitName, raidData.exit_name || "---");
          setText(elements.survivorClass, raidData.survivor_class);
          setText(elements.playTime, raidData.play_time_formatted);
          setText(elements.playerCount, raidData.player_count_in_raid);

          if (elements.killerInfoSection) {
            const killerData = raidData.killer_info;
            if (killerData && Object.keys(killerData).length > 0) {
              elements.killerInfoSection.classList.remove("d-none");
              setText(elements.killerName, killerData.name, "Nieznany");
              setText(elements.killerRole, killerData.role_translated);
              setText(elements.killerSide, killerData.side);
              setText(elements.killerWeapon, killerData.weapon_name);
              setText(
                elements.killerBodypart,
                killerData.killed_by_part_translated
              );
              setText(elements.killerDamage, killerData.lethal_damage_amount);
              setText(
                elements.killerDamageType,
                killerData.lethal_damage_type_translated
              );
            } else {
              elements.killerInfoSection.classList.add("d-none");
            }
          }

          const sessionStats = raidData.session_stats || {};
          setText(
            elements.expTotal,
            formatNumberForJS(raidData.total_session_exp_calculated)
          );
          setText(
            elements.expJson,
            formatNumberForJS(raidData.total_session_exp_from_json)
          );
          setText(elements.expMult, `${raidData.session_exp_mult || 1}x`);
          setText(elements.expBonus, `${raidData.experience_bonus_mult || 1}x`);
          setText(elements.expKill, formatNumberForJS(sessionStats.exp_kill));
          setText(
            elements.expLoot,
            formatNumberForJS(sessionStats.exp_looting)
          );
          setText(
            elements.expExit,
            formatNumberForJS(sessionStats.exp_exit_status)
          );

          setText(
            elements.dmgDealt,
            formatNumberForJS(sessionStats.damage_dealt)
          );
          setText(
            elements.dmgReceived,
            formatNumberForJS(sessionStats.damage_received_total)
          );
          setText(elements.distance, sessionStats.distance_formatted);
          setText(
            elements.bloodloss,
            formatNumberForJS(sessionStats.blood_loss)
          );
          setText(elements.deaths, formatNumberForJS(sessionStats.deaths));

          if (elements.dmgReceivedDetails && elements.noDmgReceived) {
            const dmgReceivedDetailsData = sessionStats.damage_received_details;
            if (
              dmgReceivedDetailsData &&
              Object.keys(dmgReceivedDetailsData).length > 0
            ) {
              let dmgDetailsHtml = "";
              const orderedParts = [
                "Głowa",
                "Klatka piersiowa",
                "Brzuch",
                "Lewa ręka",
                "Prawa ręka",
                "Lewa noga",
                "Prawa noga",
              ];
              orderedParts.forEach((partName) => {
                if (dmgReceivedDetailsData[partName] !== undefined) {
                  dmgDetailsHtml += createDamageCard(
                    partName,
                    dmgReceivedDetailsData[partName]
                  );
                }
              });
              for (const [part, dmg] of Object.entries(
                dmgReceivedDetailsData
              )) {
                if (!orderedParts.includes(part))
                  dmgDetailsHtml += createDamageCard(part, dmg);
              }
              setHtml(elements.dmgReceivedDetails, dmgDetailsHtml);
              elements.noDmgReceived.classList.add("d-none");
            } else {
              setHtml(elements.dmgReceivedDetails, "");
              elements.noDmgReceived.classList.remove("d-none");
            }
          }

          if (elements.vitalsList) {
            let vitalsHtml = "";
            const vitals = raidData.final_vitals;
            if (vitals) {
              vitalsHtml += createProgressBarVitals(
                "Energia",
                vitals.Energy,
                vitals.MaxEnergy
              );
              vitalsHtml += createProgressBarVitals(
                "Nawodnienie",
                vitals.Hydration,
                vitals.MaxHydration
              );
              vitalsHtml += createProgressBarVitals(
                "Temperatura",
                vitals.Temperature,
                40
              );
              vitalsHtml += createProgressBarVitals(
                "Trucizna",
                vitals.Poison,
                100
              );
            }
            setHtml(
              elements.vitalsList,
              vitalsHtml || '<li class="list-group-item">Brak danych</li>'
            );
          }

          if (elements.bodypartsList) {
            let bodypartsHtml = "";
            const health = raidData.final_health;
            if (health && Object.keys(health).length > 0) {
              const orderedParts = [
                "Głowa",
                "Klatka piersiowa",
                "Brzuch",
                "Lewa ręka",
                "Prawa ręka",
                "Lewa noga",
                "Prawa noga",
              ];
              orderedParts.forEach((partName) => {
                if (health[partName]) {
                  const part = health[partName];
                  bodypartsHtml += createProgressBarBody(
                    partName,
                    part.current,
                    part.maximum,
                    part.effects
                  );
                }
              });
            }
            setHtml(
              elements.bodypartsList,
              bodypartsHtml || '<li class="list-group-item">Brak danych</li>'
            );
          }

          // Umiejętności
          if (elements.skillsSection && elements.noSkillsChanged) {
            const skills = raidData.skills_changed; // To jest już lista obiektów z API
            if (skills && skills.length > 0) {
              let commonSkillsHtml =
                '<h4 class="mb-1 card p-3">Common</h4><ol class="list-group">';
              let masteringSkillsHtml =
                '<h4 class="mb-1 card p-3">Mastering</h4><ol class="list-group">';
              let commonCount = 0;
              let masteringCount = 0;
              skills.forEach((skill) => {
                const skillHtml = `
                          <li class="list-group-item d-flex justify-content-between align-items-start p-3 gap-5 shadow">
                              <div class="col">
                                  <div class="fw-bold fs-4 mb-2">${
                                    skill.SkillName || "N/A"
                                  }</div>
                                  <div class="progress" role="progressbar" aria-valuenow="${
                                    parseFloat(skill.Progress) || 0
                                  }" aria-valuemin="0" aria-valuemax="100" style="height: 20px;">
                                      <div class="progress-bar ${
                                        skill.SkillType === "Common"
                                          ? "text-bg-info"
                                          : "text-bg-warning"
                                      } progress-bar-striped progress-bar-animated" style="width: ${
                  parseFloat(skill.Progress) || 0
                }%">
                                          ${
                                            skill.ProgressFormatted ||
                                            skill.Progress ||
                                            "0.00"
                                          }
                                      </div>
                                  </div>
                              </div>
                              <span class="badge ${
                                skill.SkillType === "Common"
                                  ? "text-bg-info"
                                  : "text-bg-warning"
                              } border-0 p-3 fs-6">
                                  ${
                                    skill.PointsEarnedFormatted &&
                                    skill.PointsEarnedFormatted !== "N/A" &&
                                    skill.PointsEarnedFormatted !== "0.00" &&
                                    skill.PointsEarnedFormatted !== "0"
                                      ? "+" + skill.PointsEarnedFormatted
                                      : skill.SkillType === "Mastering"
                                      ? `Poziom ${
                                          skill.ProgressFormatted ||
                                          skill.Progress ||
                                          "0.00"
                                        }`
                                      : "---"
                                  }
                              </span>
                          </li>`;
                if (skill.SkillType === "Common") {
                  commonSkillsHtml += skillHtml;
                  commonCount++;
                } else if (skill.SkillType === "Mastering") {
                  masteringSkillsHtml += skillHtml;
                  masteringCount++;
                }
              });
              commonSkillsHtml +=
                (commonCount === 0
                  ? '<li class="list-group-item">Brak zmian/danych.</li>'
                  : "") + "</ol>";
              masteringSkillsHtml +=
                (masteringCount === 0
                  ? '<li class="list-group-item">Brak zmian/danych.</li>'
                  : "") + "</ol>";
              setHtml(
                elements.skillsSection,
                `<div class="row g-3"><div class="col-md-6">${commonSkillsHtml}</div><div class="col-md-6">${masteringSkillsHtml}</div></div>`
              );
              elements.noSkillsChanged.classList.add("d-none");
            } else {
              setHtml(elements.skillsSection, "");
              elements.noSkillsChanged.classList.remove("d-none");
            }
          }

          createItemListJS(raidData.found_in_raid_items, "modal-found-items");
          createItemListJS(raidData.transfer_items, "modal-transfer-items");
          createItemListJS(raidData.dropped_items, "modal-dropped-items");
          createItemListJS(raidData.lost_insured_items, "modal-lost-items");

          if (modalLoader) modalLoader.classList.add("d-none");
          if (modalContent) modalContent.classList.remove("d-none");
        })
        .catch((error) => {
          console.error("Pełny błąd fetch dla modala:", error);
          if (modalLoader) modalLoader.classList.add("d-none");
          if (modalError)
            modalError.classList.remove(
              "d-none"
            ).textContent = `Błąd ładowania danych rajdu: ${error.message}`;
        });
    });
  });
</script>
{% endblock %}
